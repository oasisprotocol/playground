{"version":3,"file":"CreatePollView.1a05ec40.js","sources":["../../src/components/RemoveIcon.vue","../../src/components/AddIcon.vue","../../src/views/CreatePollView.vue"],"sourcesContent":["<template>\n  <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n    <path\n      d=\"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 13H7V11H17V13Z\"\n      fill=\"#565B61\"\n    />\n  </svg>\n</template>\n\n<script setup lang=\"ts\"></script>\n\n<style scoped lang=\"postcss\"></style>\n","<template>\n  <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n    <g clip-path=\"url(#clip0_56_1176)\">\n      <path d=\"M13 7H11V11H7V13H11V17H13V13H17V11H13V7ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z\" fill=\"currentColor\"/>\n    </g>\n    <defs>\n      <clipPath id=\"clip0_56_1176\">\n        <rect width=\"24\" height=\"24\" fill=\"white\"/>\n      </clipPath>\n    </defs>\n  </svg>\n</template>\n\n<script setup lang=\"ts\"></script>\n\n<style scoped lang=\"postcss\"></style>\n","<script setup lang=\"ts\">\nimport { ref } from 'vue';\n\nimport { useDAOv1, useGaslessVoting, useUnwrappedDAOv1, useUnwrappedGaslessVoting } from '../contracts';\nimport { Network, useEthereumStore } from '../stores/ethereum';\nimport type { Poll } from '../../../functions/api/types';\nimport AppButton from '@/components/AppButton.vue';\nimport RemoveIcon from '@/components/RemoveIcon.vue';\nimport AddIcon from '@/components/AddIcon.vue';\nimport SuccessInfo from '@/components/SuccessInfo.vue';\n\nconst eth = useEthereumStore();\nconst dao = useDAOv1();\nconst uwdao = useUnwrappedDAOv1();\nconst gaslessVoting = useGaslessVoting();\nconst unwrappedGaslessVoting = useUnwrappedGaslessVoting();\n\nconst pinBody = async (jwt: string, poll: Poll) => {\n  const res = await fetch('https://api.pinata.cloud/pinning/pinJSONToIPFS', {\n    method: 'POST',\n    headers: {\n      'content-type': 'application/json',\n      authorization: `Bearer ${jwt}`,\n    },\n    body: JSON.stringify({\n      pinataContent: poll,\n    }),\n  });\n  const resBody: any = await res.json();\n  if (res.status !== 200) throw new Error('failed to pin');\n  const resp = { ipfsHash: resBody.IpfsHash };\n  return new Response(JSON.stringify(resp), {\n    status: 201,\n    headers: { 'content-type': 'application/json' },\n  });\n};\n\nconst errors = ref<string[]>([]);\nconst pollName = ref('');\nconst pollDesc = ref('');\nconst choices = ref<Array<{ key: number; value: string }>>([]);\nconst publishVotes = ref(false);\nconst isLoading = ref(false);\nconst proposalId = ref('');\n\nlet choiceCount = 0; // a monotonic counter for use as :key\nconst removeChoice = (i: number) => choices.value.splice(i, 1);\nconst addChoice = () => {\n  choices.value.push({ key: choiceCount, value: '' });\n  choiceCount++;\n};\naddChoice();\naddChoice();\naddChoice();\n\nasync function createPoll(e: Event): Promise<void> {\n  if (e.target instanceof HTMLFormElement) {\n    e.target.checkValidity();\n    if (!e.target.reportValidity()) return;\n  }\n  e.preventDefault();\n  try {\n    errors.value.splice(0, errors.value.length);\n    isLoading.value = true;\n    proposalId.value = await doCreatePoll();\n    // if (!proposalId) return;\n    // router.push({ name: 'poll', params: { id: proposalId } });\n  } catch (e: any) {\n    errors.value.push(`Failed to create poll: ${e.message ?? JSON.stringify(e)}`);\n    console.error(e);\n  } finally {\n    isLoading.value = false;\n  }\n}\n\nasync function doCreatePoll(): Promise<string> {\n  await eth.connect();\n  await eth.switchNetwork(Network.FromConfig);\n  if (errors.value.length > 0) return '';\n\n  const poll: Poll = {\n    creator: eth.address!,\n    name: pollName.value,\n    description: pollDesc.value,\n    choices: choices.value.map((c) => c.value),\n    options: {\n      publishVotes: publishVotes.value,\n    },\n  };\n\n  const res = await pinBody(import.meta.env.VITE_PINATA_JWT!, poll);\n  const resJson = await res.json();\n  if (res.status !== 201) throw new Error(resJson.error);\n  const ipfsHash = resJson.ipfsHash;\n\n  const proposalParams = {\n    ipfsHash,\n    numChoices: choices.value.length,\n    publishVotes: poll.options.publishVotes,\n  };\n\n  let proposalId : string;\n\n  const gv = (await gaslessVoting).value;\n  const ugv = (await unwrappedGaslessVoting).value;\n\n  console.log('doCreatePoll: Using direct transaction to create proposal');\n\n  // TODO: check if proposal already exists on the host chain and continue if so (idempotence)\n  //proposalId = await dao.value.callStatic.createProposal(proposalParams);\n  //console.log('doCreatePoll: creating proposal', proposalId);\n\n  const createProposalTx = await dao.value.createProposal(proposalParams);\n  console.log('doCreatePoll: creating proposal tx', createProposalTx.hash);\n  const receipt = await createProposalTx.wait();\n  if (receipt.status !== 1) {\n    throw new Error('createProposal tx receipt reported failure.');\n  }\n  proposalId = receipt.logs[0].data;\n\n  console.log('doCreatePoll: Proposal ID', proposalId);\n\n  let isActive = false;\n  while (!isActive) {\n    console.log('doCreatePoll: checking if ballot has been created on Sapphire', proposalId);\n    isActive = await uwdao.value.callStatic.ballotIsActive(proposalId!);\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n  return proposalId!.replace('0x', '');\n}\n</script>\n\n<template>\n  <section v-if=\"!proposalId\">\n    <h2 class=\"capitalize text-white text-2xl font-bold mb-4\">New pool</h2>\n    <p class=\"text-white text-base mb-20\">\n      Create your new poll by filling out the fields below. Once created, your poll will be live\n      immediately and responses will start being recorded.\n    </p>\n\n    <form @submit=\"createPoll\">\n      <div class=\"form-group\">\n        <input type=\"text\" id=\"question\" class=\"peer\" placeholder=\" \" v-model=\"pollName\" required />\n        <label\n          for=\"question\"\n          class=\"peer-focus:text-primaryDark peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-5\"\n        >\n          Question\n          <span class=\"text-red-500\">*</span>\n        </label>\n      </div>\n\n      <div class=\"form-group form-group-textarea\">\n        <textarea id=\"description\" class=\"peer\" placeholder=\" \" v-model=\"pollDesc\" rows=\"3\" />\n        <label\n          for=\"description\"\n          class=\"peer-focus:text-primaryDark peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-5\"\n        >\n          Description\n        </label>\n      </div>\n\n      <div class=\"form-group-extended\">\n        <label class=\"inline-block mb-5\"\n          >Answers\n          <span class=\"text-red-500\">*</span>\n        </label>\n        <div\n          class=\"relative flex justify-between items-center mb-4 gap-3 px-5\"\n          v-for=\"(choice, i) in choices\"\n          :key=\"choice.key\"\n        >\n          <input\n            class=\"focus:outline-none focus:ring-0 pb-2 text-primaryDark\"\n            type=\"text\"\n            id=\"name\"\n            :placeholder=\"`${i + 1}. Answer`\"\n            v-model=\"choices[i].value\"\n            required\n          />\n\n          <RemoveIcon\n            class=\"cursor-pointer absolute right-5 bottom-2\"\n            :class=\"{\n              'cursor-default': isLoading,\n            }\"\n            :disabled=\"isLoading\"\n            v-if=\"choices.length > 2\"\n            :data-ix=\"i\"\n            @click.prevent=\"removeChoice(i)\"\n          ></RemoveIcon>\n        </div>\n        <AppButton\n          class=\"ml-5\"\n          size=\"small\"\n          variant=\"tertiary\"\n          :disabled=\"isLoading\"\n          @click.prevent=\"addChoice\"\n        >\n          <span class=\"flex gap-2\">\n            <AddIcon />\n            <span class=\"leading-6\">Add answer</span>\n          </span>\n        </AppButton>\n      </div>\n\n      <div class=\"form-group-extended\">\n        <label class=\"inline-block mb-5\">Additional options</label>\n        <div class=\"flex pl-4\">\n          <input\n            id=\"publish-votes\"\n            class=\"w-5 h-5 border-2 border-gray-500\"\n            type=\"checkbox\"\n            v-model=\"publishVotes\"\n          />\n          <label class=\"ml-3 text-base text-gray-900\" for=\"publish-votes\">\n            Publish individual votes after voting has ended.\n          </label>\n        </div>\n      </div>\n\n      <AppButton type=\"submit\" variant=\"primary\" :disabled=\"isLoading\">\n        <span v-if=\"isLoading\">Creatingâ€¦</span>\n        <span v-else>Create Poll</span>\n      </AppButton>\n\n      <div v-if=\"errors.length > 0\" class=\"text-red-500 px-3 mt-5 rounded-xl-sm\">\n        <span class=\"font-bold\">Errors:</span>\n        <ul class=\"list-disc px-8\">\n          <li v-for=\"error in errors\" :key=\"error\">{{ error }}</li>\n        </ul>\n      </div>\n    </form>\n  </section>\n  <section v-else>\n    <SuccessInfo>\n      <h3 class=\"text-white text-3xl mb-4\">Success</h3>\n      <p class=\"text-white text-base\">Your poll is live.</p>\n      <p class=\"text-white text-base mb-24\">Votes will be recorded from now on.</p>\n\n      <RouterLink :to=\"{ name: 'poll', params: { id: proposalId } }\">\n        <AppButton variant=\"secondary\">View poll</AppButton>\n      </RouterLink>\n    </SuccessInfo>\n  </section>\n</template>\n\n<style scoped lang=\"postcss\">\n.form-group,\n.form-group-extended {\n  @apply relative mb-6;\n}\n\n.form-group input,\ntextarea {\n  @apply block rounded-xl py-6 px-5 w-full text-base text-black appearance-none focus:outline-none focus:ring-0 bg-white;\n}\n\n.form-group label {\n  @apply absolute text-base text-primaryDark duration-300 transform -translate-y-5 scale-75 top-6 z-10 origin-[0] left-5;\n}\n\n.form-group-textarea {\n  @apply overflow-hidden;\n}\n\n.form-group-textarea textarea {\n  @apply pt-6;\n}\n\n.form-group-textarea label {\n  @apply top-6 h-10;\n  width: calc(130% - 14px);\n}\n\n.form-group-textarea label::before {\n  @apply h-10 -top-3 absolute bg-white;\n  z-index: -1;\n  content: ' ';\n  width: calc(100% - 14px); /* scrollbar */\n}\n\n.form-group-extended {\n  @apply block rounded-xl py-6 px-5 w-full appearance-none focus:outline-none focus:ring-0 bg-white;\n}\n\n.form-group-extended > label {\n  @apply text-base text-primaryDark;\n}\n\n.form-group-extended input:not([type='checkbox']) {\n  @apply w-full;\n  border-bottom: 1px solid rgba(0, 0, 0, 0.42);\n}\n</style>\n"],"names":["_hoisted_1","_hoisted_2","_createElementVNode","_hoisted_3","_sfc_render","_ctx","_cache","_hoisted_4","eth","useEthereumStore","dao","useDAOv1","uwdao","useUnwrappedDAOv1","gaslessVoting","useGaslessVoting","unwrappedGaslessVoting","useUnwrappedGaslessVoting","pinBody","jwt","poll","res","resBody","resp","errors","ref","pollName","pollDesc","choices","publishVotes","isLoading","proposalId","choiceCount","removeChoice","i","addChoice","createPoll","e","doCreatePoll","Network","c","resJson","proposalParams","createProposalTx","receipt","isActive","resolve"],"mappings":"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"}